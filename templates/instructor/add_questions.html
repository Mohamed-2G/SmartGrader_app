{% extends "base.html" %}

{% block title %}Add Questions - SmartGrader{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-plus-circle me-2"></i>
        Add Questions to Exam
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{{ url_for('instructor.dashboard') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i>
            Back to Dashboard
        </a>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-file-alt me-2"></i>
                    {{ exam.title }}
                </h5>
                <small class="text-muted">Add questions manually for better accuracy</small>
            </div>
            <div class="card-body">
                <form id="questionsForm" method="POST">
                    <div id="questionsContainer">
                        <!-- Questions will be added here dynamically -->
                    </div>
                    
                    <div class="d-flex justify-content-between mt-4">
                        <button type="button" class="btn btn-success" onclick="addQuestion()">
                            <i class="fas fa-plus me-2"></i>
                            Add Question
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>
                            Save Questions
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    Instructions
                </h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <h6>How to add questions:</h6>
                    <ul class="mb-0">
                        <li>Click "Add Question" to add each question</li>
                        <li>Enter the complete question text</li>
                        <li>Set the point value for each question</li>
                        <li>Questions will be numbered automatically</li>
                        <li>You can reorder questions by dragging</li>
                    </ul>
                </div>
                
                <div class="alert alert-warning">
                    <h6>Tips for better grading:</h6>
                    <ul class="mb-0">
                        <li>Be specific about what you want students to answer</li>
                        <li>Include clear instructions in the question</li>
                        <li>Set appropriate point values based on complexity</li>
                        <li>Use action verbs like "explain", "describe", "compare"</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Question Template (hidden) -->
<template id="questionTemplate">
    <div class="question-item mb-4 p-3 border rounded" data-question-id="">
        <div class="d-flex justify-content-between align-items-start mb-3">
            <h6 class="question-number mb-0">Question 1</h6>
            <div class="d-flex gap-2">
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="moveQuestion(this, 'up')" title="Move Up">
                    <i class="fas fa-arrow-up"></i>
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="moveQuestion(this, 'down')" title="Move Down">
                    <i class="fas fa-arrow-down"></i>
                </button>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeQuestion(this)" title="Remove Question">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
        
        <div class="mb-3">
            <label class="form-label">Question Text:</label>
            <textarea 
                class="form-control question-text" 
                name="question_text[]" 
                rows="4" 
                placeholder="Enter the complete question text here..."
                required
            ></textarea>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <label class="form-label">Point Value:</label>
                <input 
                    type="number" 
                    class="form-control question-points" 
                    name="question_points[]" 
                    min="1" 
                    max="100" 
                    value="10" 
                    required
                >
            </div>
            <div class="col-md-6">
                <label class="form-label">Question Type:</label>
                <select class="form-select question-type" name="question_type[]">
                    <option value="general">General</option>
                    <option value="explain">Explain</option>
                    <option value="describe">Describe</option>
                    <option value="compare">Compare/Contrast</option>
                    <option value="analyze">Analyze</option>
                    <option value="evaluate">Evaluate</option>
                    <option value="calculate">Calculate</option>
                </select>
            </div>
        </div>
    </div>
</template>
{% endblock %}

{% block scripts %}
<script>
let questionCounter = 1;

function addQuestion() {
    const container = document.getElementById('questionsContainer');
    const template = document.getElementById('questionTemplate');
    const questionDiv = template.content.cloneNode(true);
    
    // Set question ID and number
    const questionItem = questionDiv.querySelector('.question-item');
    questionItem.setAttribute('data-question-id', questionCounter);
    
    const questionNumber = questionDiv.querySelector('.question-number');
    questionNumber.textContent = `Question ${questionCounter}`;
    
    // Add to container
    container.appendChild(questionDiv);
    questionCounter++;
    
    // Update question numbers
    updateQuestionNumbers();
}

function removeQuestion(button) {
    const questionItem = button.closest('.question-item');
    questionItem.remove();
    updateQuestionNumbers();
}

function moveQuestion(button, direction) {
    const questionItem = button.closest('.question-item');
    const container = document.getElementById('questionsContainer');
    
    if (direction === 'up' && questionItem.previousElementSibling) {
        container.insertBefore(questionItem, questionItem.previousElementSibling);
    } else if (direction === 'down' && questionItem.nextElementSibling) {
        container.insertBefore(questionItem.nextElementSibling, questionItem);
    }
    
    updateQuestionNumbers();
}

function updateQuestionNumbers() {
    const questions = document.querySelectorAll('.question-item');
    questions.forEach((question, index) => {
        const numberElement = question.querySelector('.question-number');
        numberElement.textContent = `Question ${index + 1}`;
        question.setAttribute('data-question-id', index + 1);
    });
}

// Form submission
document.getElementById('questionsForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const questions = [];
    const questionItems = document.querySelectorAll('.question-item');
    
    questionItems.forEach((item, index) => {
        const text = item.querySelector('.question-text').value.trim();
        const points = parseInt(item.querySelector('.question-points').value);
        const type = item.querySelector('.question-type').value;
        
        if (text && points > 0) {
            questions.push({
                number: index + 1,
                text: text,
                max_points: points,
                type: type
            });
        }
    });
    
    if (questions.length === 0) {
        alert('Please add at least one question.');
        return;
    }
    
    // Submit the questions
    fetch(`/instructor/exam/{{ exam.id }}/add-questions`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            questions: questions
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Questions saved successfully!');
            window.location.href = `/instructor/exam/{{ exam.id }}`;
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while saving questions.');
    });
});

// Add first question automatically
document.addEventListener('DOMContentLoaded', function() {
    addQuestion();
});
</script>
{% endblock %}
