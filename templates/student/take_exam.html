{% extends "base.html" %}

{% block title %}{{ get_text('student_take_exam') }} - SmartGrader{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-file-alt me-2"></i>
        {{ exam.title }}
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{{ url_for('student.dashboard') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i>
            {{ get_text('back_to_dashboard') }}
        </a>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-question-circle me-2"></i>
                    {{ get_text('exam_questions_header') }}
                </h5>
                                        <small class="text-muted">{{ exam.subject or get_text('general_label') }} ‚Ä¢ {{ exam.questions|length }} {{ get_text('questions_label')|lower }} ‚Ä¢ {{ exam.total_points }} {{ get_text('total_points_label')|lower }}</small>
            </div>
            <div class="card-body">
                {% if exam.questions and exam.questions|length > 0 %}
                    <form id="examForm">
                        {% for question in exam.questions %}
                        <div class="mb-4 p-3 border rounded">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <h6 class="mb-0">{{ get_text('question_label') }} {{ loop.index }}</h6>
                                <span class="badge bg-primary">{{ question.points }} {{ get_text('points_label') }}</span>
                            </div>
                            
                            <div class="mb-3">
                                <p class="mb-2">{{ question.question_text }}</p>
                            </div>
                            
                            <div class="mb-3">
                                <label for="answer_{{ question.id }}" class="form-label">{{ get_text('your_answer_label') }}:</label>
                                <textarea 
                                    class="form-control" 
                                    id="answer_{{ question.id }}" 
                                    name="answer_{{ question.id }}" 
                                    rows="4" 
                                    placeholder="{{ get_text('type_answer_placeholder') }}"
                                ></textarea>
                            </div>
                            
                            <!-- File Upload Section -->
                            <div class="mb-3">
                                <label for="file_{{ question.id }}" class="form-label">
                                    <i class="fas fa-paperclip me-1"></i>
                                    {{ get_text('upload_file_optional') }}
                                </label>
                                <input type="file" 
                                       class="form-control" 
                                       id="file_{{ question.id }}" 
                                       name="file_{{ question.id }}"
                                       accept=".pdf,.jpg,.jpeg,.png,.gif,.bmp,.tiff,.txt">
                                <div class="form-text">{{ get_text('upload_file_help') }}</div>
                            </div>
                        </div>
                        {% endfor %}
                        
                        <!-- Main Submission File Upload -->
                        <div class="mb-4 p-3 border rounded bg-light">
                            <h6 class="mb-3">
                                <i class="fas fa-upload me-2"></i>
                                {{ get_text('complete_answer_file_optional') }}
                            </h6>
                            <div class="mb-3">
                                <label for="main_submission_file" class="form-label">{{ get_text('upload_complete_answer_label') }}</label>
                                <input type="file" 
                                       class="form-control" 
                                       id="main_submission_file" 
                                       name="main_submission_file"
                                       accept=".pdf,.jpg,.jpeg,.png,.gif,.bmp,.tiff,.txt,.doc,.docx">
                                <div class="form-text">
                                    <strong>üìù Smart Answer Detection:</strong> Upload a complete answer file (PDF, image, or document) containing all your answers. 
                                    The system will automatically detect and match your answers to the correct questions based on numbering and order.
                                    <br><br>
                                    <strong>üí° Tips for best results:</strong>
                                    <ul class="mb-0">
                                        <li>Number your answers clearly: "Question 1:", "Q1:", "1.", or "1)"</li>
                                        <li>Make sure your handwriting is clear and legible</li>
                                        <li>Include all answers in a single file</li>
                                        <li>The system will also use your individual text answers above if available</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between">
                            <button type="button" class="btn btn-secondary" onclick="saveProgress()">
                                <i class="fas fa-save me-2"></i>
                                {{ get_text('save_progress') }}
                            </button>
                            <button type="submit" class="btn btn-primary" onclick="submitExam(event)">
                                <i class="fas fa-paper-plane me-2"></i>
                                {{ get_text('student_submit_exam') }}
                            </button>
                        </div>
                    </form>
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                        <h5 class="text-warning">{{ get_text('no_questions_available') }}</h5>
                        <p class="text-muted">{{ get_text('no_questions_yet') }}</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card sticky-top" style="top: 1rem;">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    {{ get_text('exam_information') }}
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <strong>{{ get_text('exam_label') }}:</strong> {{ exam.title }}
                </div>
                <div class="mb-3">
                    <strong>{{ get_text('subject_label') }}:</strong> {{ exam.subject or get_text('general_label') }}
                </div>
                <div class="mb-3">
                    <strong>{{ get_text('questions_label') }}:</strong> {{ exam.questions|length }}
                </div>
                <div class="mb-3">
                    <strong>{{ get_text('total_points_label') }}:</strong> {{ exam.total_points }}
                </div>
                <div class="mb-3">
                    <strong>{{ get_text('time_limit_label') }}:</strong> {{ get_text('no_time_limit') }}
                </div>
                
                <hr>
                
                <div class="mb-3">
                    <h6>{{ get_text('progress_label') }}</h6>
                    <div class="progress mb-2">
                        <div class="progress-bar" id="progressBar" role="progressbar" style="width: 0%"></div>
                    </div>
                    <small class="text-muted" id="progressText">0 of {{ exam.questions|length }} questions answered</small>
                </div>
                
                <div class="alert alert-info">
                    <i class="fas fa-lightbulb me-2"></i>
                    <strong>Tips:</strong>
                    <ul class="mb-0 mt-2 small">
                        <li>Take your time to read each question carefully</li>
                        <li>Provide detailed answers for better grading</li>
                        <li>You can save your progress and return later</li>
                        <li>Once submitted, you cannot change your answers</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Submit Confirmation Modal -->
<div class="modal fade" id="submitModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2 text-warning"></i>
                    {{ get_text('confirm_submission') }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>{{ get_text('confirm_submit_exam') }}</p>
                <p class="text-muted small">{{ get_text('submit_final_notice') }}</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ get_text('btn_cancel') }}</button>
                <button type="button" class="btn btn-primary" onclick="confirmSubmit()">{{ get_text('student_submit_exam') }}</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let examData = {
    examId: {{ exam.id }},
    answers: {}
};

// Update progress bar
function updateProgress() {
    const totalQuestions = {{ exam.questions|length }};
    const answeredQuestions = Object.keys(examData.answers).length;
    const progress = (answeredQuestions / totalQuestions) * 100;
    
    document.getElementById('progressBar').style.width = progress + '%';
    document.getElementById('progressText').textContent = `${answeredQuestions} of ${totalQuestions} questions answered`;
}

// Save answer to examData
function saveAnswer(questionId, answer) {
    if (answer.trim()) {
        examData.answers[questionId] = answer;
    } else {
        delete examData.answers[questionId];
    }
    updateProgress();
}

// Save progress to localStorage
function saveProgress() {
    localStorage.setItem('examProgress_{{ exam.id }}', JSON.stringify(examData));
    alert('Progress saved successfully!');
}

// Load progress from localStorage
function loadProgress() {
    const saved = localStorage.getItem('examProgress_{{ exam.id }}');
    if (saved) {
        examData = JSON.parse(saved);
        
        // Fill in saved answers
        Object.keys(examData.answers).forEach(questionId => {
            const textarea = document.getElementById(`answer_${questionId}`);
            if (textarea) {
                textarea.value = examData.answers[questionId];
            }
        });
        
        updateProgress();
    }
}

// Submit exam
function submitExam(event) {
    event.preventDefault();
    
    // Create FormData for file uploads
    const formData = new FormData();
    
    // Collect all answers and files
    {% for question in exam.questions %}
    const answer{{ question.id }} = document.getElementById('answer_{{ question.id }}').value;
    const file{{ question.id }} = document.getElementById('file_{{ question.id }}').files[0];
    
    if (answer{{ question.id }}.trim()) {
        formData.append('answer_{{ question.id }}', answer{{ question.id }});
    }
    
    if (file{{ question.id }}) {
        formData.append('file_{{ question.id }}', file{{ question.id }});
    }
    {% endfor %}
    
    // Add main submission file if present
    const mainFile = document.getElementById('main_submission_file').files[0];
    if (mainFile) {
        formData.append('main_submission_file', mainFile);
        console.log('üìÑ Main submission file detected:', mainFile.name);
    }
    
    // Check if any questions are answered
    const totalQuestions = {{ exam.questions|length }};
    let answeredQuestions = 0;
    
    {% for question in exam.questions %}
    if (document.getElementById('answer_{{ question.id }}').value.trim() || 
        document.getElementById('file_{{ question.id }}').files.length > 0) {
        answeredQuestions++;
    }
    {% endfor %}
    
    if (answeredQuestions < totalQuestions) {
        if (!confirm(`You have answered ${answeredQuestions} out of ${totalQuestions} questions. Do you want to submit anyway?`)) {
            return;
        }
    }
    
    // Show confirmation modal
    const modal = new bootstrap.Modal(document.getElementById('submitModal'));
    modal.show();
    
    // Store formData for later use
    window.examFormData = formData;
}

// Confirm and submit
function confirmSubmit() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('submitModal'));
    modal.hide();
    
    // Show loading state
    const submitBtn = document.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Submitting...';
    submitBtn.disabled = true;
    
    // Submit to server using FormData
    fetch(`/student/exam/{{ exam.id }}/submit`, {
        method: 'POST',
        body: window.examFormData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Clear saved progress
            localStorage.removeItem('examProgress_{{ exam.id }}');
            
            // Redirect to submission view
            window.location.href = `/student/submission/${data.submission_id}`;
        } else {
            alert('Error: ' + data.error);
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while submitting the exam');
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
}

// Add event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Load saved progress
    loadProgress();
    
    // Add change listeners to all textareas
    {% for question in exam.questions %}
    document.getElementById('answer_{{ question.id }}').addEventListener('input', function() {
        saveAnswer('{{ question.id }}', this.value);
    });
    {% endfor %}
    
    // Auto-save every 30 seconds
    setInterval(saveProgress, 30000);
});
</script>
{% endblock %} 