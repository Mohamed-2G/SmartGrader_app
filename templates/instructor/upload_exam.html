{% extends "base.html" %}

{% block title %}Upload Exam{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card">
                <div class="card-header">
                    <h3>üìÑ Create New Exam</h3>
                    <p class="text-muted">Upload an exam file or create questions manually</p>
                </div>
                <div class="card-body">
                    <form method="POST" enctype="multipart/form-data" id="examForm" action="{{ url_for('instructor.upload_exam') }}">
                        <div class="mb-3">
                            <label for="title" class="form-label">Exam Title *</label>
                            <input type="text" class="form-control" id="title" name="title" required 
                                   placeholder="e.g., Midterm Exam - Mathematics 101">
                        </div>
                        
                        <div class="mb-3">
                            <label for="subject" class="form-label">Subject</label>
                            <input type="text" class="form-control" id="subject" name="subject" 
                                   placeholder="e.g., Mathematics, Physics, English">
                        </div>
                        
                        <div class="mb-3">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control" id="description" name="description" rows="3" 
                                      placeholder="Brief description of the exam content"></textarea>
                        </div>
                        
                        <!-- Question Creation Method -->
                        <div class="mb-4">
                            <label class="form-label">Question Creation Method *</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="creation_method" id="method_manual" value="manual" checked>
                                <label class="form-check-label" for="method_manual">
                                    <strong>Create Questions Manually</strong> (Recommended)
                                </label>
                                <small class="form-text text-muted d-block">Add questions one by one with exact point values</small>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="creation_method" id="method_upload" value="upload">
                                <label class="form-check-label" for="method_upload">
                                    <strong>Upload PDF/File</strong>
                                </label>
                                <small class="form-text text-muted d-block">Upload a file and let AI extract questions (may not work perfectly)</small>
                            </div>
                        </div>
                        
                        <!-- Manual Question Creation -->
                        <div id="manualQuestions" class="mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5>üìù Exam Questions</h5>
                                <button type="button" class="btn btn-success btn-sm" onclick="addQuestion()">
                                    <i class="fas fa-plus me-1"></i>Add Question
                                </button>
                            </div>
                            <div id="questionsContainer">
                                <!-- Questions will be added here dynamically -->
                            </div>
                        </div>
                        
                        <!-- File Upload Section -->
                        <div id="fileUploadSection" class="mb-4" style="display: none;">
                            <div class="mb-3">
                                <label for="exam_file" class="form-label">Exam File</label>
                                <input type="file" class="form-control" id="exam_file" name="exam_file" 
                                       accept=".pdf,.jpg,.jpeg,.png,.gif,.bmp,.tiff,.doc,.docx,.txt">
                                <div class="form-text">
                                    Supported formats: PDF, Images (JPG, PNG, GIF, BMP, TIFF), Documents (DOC, DOCX, TXT)
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-info">
                            <h6>üìã What happens after creation?</h6>
                            <ul class="mb-0">
                                <li>Your exam will be saved with the exact questions and point values you specify</li>
                                <li>Students can immediately take the exam with your questions</li>
                                <li>AI will grade student submissions with detailed, personalized feedback</li>
                                <li>You can edit questions later if needed</li>
                            </ul>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary" id="submitBtn">
                                <i class="fas fa-save"></i> Create Exam
                            </button>
                            <a href="{{ url_for('instructor.dashboard') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left"></i> Back to Dashboard
                            </a>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="card mt-4">
                <div class="card-header">
                    <h5>üí° Tips for Better Results</h5>
                </div>
                <div class="card-body">
                    <ul class="mb-0">
                        <li><strong>Manual Creation:</strong> Most reliable way to ensure accurate questions and point values</li>
                        <li><strong>Clear Questions:</strong> Be specific about what you want students to answer</li>
                        <li><strong>Point Values:</strong> Set appropriate points based on question complexity and importance</li>
                        <li><strong>Question Types:</strong> Use action verbs like "explain", "describe", "compare", "analyze"</li>
                        <li><strong>Instructions:</strong> Include clear instructions in your questions for better student responses</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Question Template (hidden) -->
<template id="questionTemplate">
    <div class="question-item mb-3 p-3 border rounded" data-question-id="">
        <div class="d-flex justify-content-between align-items-start mb-3">
            <h6 class="question-number mb-0">Question 1</h6>
            <div class="d-flex gap-1">
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="moveQuestion(this, 'up')" title="Move Up">
                    <i class="fas fa-arrow-up"></i>
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="moveQuestion(this, 'down')" title="Move Down">
                    <i class="fas fa-arrow-down"></i>
                </button>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeQuestion(this)" title="Remove Question">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
        
        <div class="mb-3">
            <label class="form-label">Question Text:</label>
            <textarea 
                class="form-control question-text" 
                name="question_text[]" 
                rows="3" 
                placeholder="Enter the complete question text here..."
                required
            ></textarea>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <label class="form-label">Point Value:</label>
                <input 
                    type="number" 
                    class="form-control question-points" 
                    name="question_points[]" 
                    min="1" 
                    max="100" 
                    value="5" 
                    required
                >
            </div>
            <div class="col-md-6">
                <label class="form-label">Question Type:</label>
                <select class="form-select question-type" name="question_type[]">
                    <option value="general">General</option>
                    <option value="explain">Explain</option>
                    <option value="describe">Describe</option>
                    <option value="compare">Compare/Contrast</option>
                    <option value="analyze">Analyze</option>
                    <option value="evaluate">Evaluate</option>
                    <option value="calculate">Calculate</option>
                    <option value="define">Define</option>
                    <option value="discuss">Discuss</option>
                </select>
            </div>
        </div>
    </div>
</template>
{% endblock %}

{% block scripts %}
<script>
let questionCounter = 1;

// Handle creation method change
document.querySelectorAll('input[name="creation_method"]').forEach(radio => {
    radio.addEventListener('change', function() {
        const manualSection = document.getElementById('manualQuestions');
        const fileSection = document.getElementById('fileUploadSection');
        const fileInput = document.getElementById('exam_file');
        
        if (this.value === 'manual') {
            manualSection.style.display = 'block';
            fileSection.style.display = 'none';
            fileInput.removeAttribute('required');
            
            // Enable required attributes for manual questions
            const questionTexts = document.querySelectorAll('.question-text');
            const questionPoints = document.querySelectorAll('.question-points');
            questionTexts.forEach(input => input.setAttribute('required', 'required'));
            questionPoints.forEach(input => input.setAttribute('required', 'required'));
        } else {
            manualSection.style.display = 'none';
            fileSection.style.display = 'block';
            fileInput.setAttribute('required', 'required');
            
            // Remove required attributes from manual questions when using file upload
            const questionTexts = document.querySelectorAll('.question-text');
            const questionPoints = document.querySelectorAll('.question-points');
            questionTexts.forEach(input => input.removeAttribute('required'));
            questionPoints.forEach(input => input.removeAttribute('required'));
        }
    });
});

function addQuestion() {
    const container = document.getElementById('questionsContainer');
    const template = document.getElementById('questionTemplate');
    const questionDiv = template.content.cloneNode(true);
    
    // Set question ID and number
    const questionItem = questionDiv.querySelector('.question-item');
    questionItem.setAttribute('data-question-id', questionCounter);
    
    const questionNumber = questionDiv.querySelector('.question-number');
    questionNumber.textContent = `Question ${questionCounter}`;
    
    // Add to container
    container.appendChild(questionDiv);
    questionCounter++;
    
    // Update question numbers
    updateQuestionNumbers();
}

function removeQuestion(button) {
    const questionItem = button.closest('.question-item');
    questionItem.remove();
    updateQuestionNumbers();
}

function moveQuestion(button, direction) {
    const questionItem = button.closest('.question-item');
    const container = document.getElementById('questionsContainer');
    
    if (direction === 'up' && questionItem.previousElementSibling) {
        container.insertBefore(questionItem, questionItem.previousElementSibling);
    } else if (direction === 'down' && questionItem.nextElementSibling) {
        container.insertBefore(questionItem.nextElementSibling, questionItem);
    }
    
    updateQuestionNumbers();
}

function updateQuestionNumbers() {
    const questions = document.querySelectorAll('.question-item');
    questions.forEach((question, index) => {
        const numberElement = question.querySelector('.question-number');
        numberElement.textContent = `Question ${index + 1}`;
        question.setAttribute('data-question-id', index + 1);
    });
}

// Form validation - SIMPLIFIED VERSION
document.getElementById('examForm').addEventListener('submit', function(e) {
    console.log('Form submission triggered');
    const creationMethod = document.querySelector('input[name="creation_method"]:checked').value;
    console.log('Creation method:', creationMethod);
    
    // Show loading state
    const submitButton = document.querySelector('button[type="submit"]');
    submitButton.disabled = true;
    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Exam...';
    
    // Let the form submit without any validation for now
    console.log('Allowing form submission to proceed...');
    console.log('Form will submit to:', this.action);
    console.log('Form method:', this.method);
    console.log('Form enctype:', this.enctype);
    
    // Don't prevent default - let it submit
    return true;
});

// Add first question automatically
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM Content Loaded');
    
    try {
        addQuestion();
        console.log('Question added successfully');
        
        // Initialize form state based on selected method
        const selectedMethod = document.querySelector('input[name="creation_method"]:checked').value;
        if (selectedMethod === 'upload') {
            // Remove required attributes from manual questions when file upload is selected
            const questionTexts = document.querySelectorAll('.question-text');
            const questionPoints = document.querySelectorAll('.question-points');
            questionTexts.forEach(input => input.removeAttribute('required'));
            questionPoints.forEach(input => input.removeAttribute('required'));
        }
    } catch (error) {
        console.error('Error adding question:', error);
    }
    
    // Add debug logging for form submission
    const form = document.getElementById('examForm');
    if (form) {
        console.log('Form found:', form);
        console.log('Form action:', form.action);
        console.log('Form method:', form.method);
        console.log('Form enctype:', form.enctype);
    } else {
        console.error('Form not found!');
    }
    
    // Test button click
    const submitBtn = document.getElementById('submitBtn');
    if (submitBtn) {
        submitBtn.addEventListener('click', function(e) {
            console.log('Submit button clicked');
            
            // Force form submission if needed
            setTimeout(() => {
                const form = document.getElementById('examForm');
                if (form) {
                    console.log('Forcing form submission...');
                    // form.submit();
                }
            }, 100);
        });
        console.log('Submit button event listener added');
    } else {
        console.error('Submit button not found!');
    }
    
    // Test form submission directly
    if (form) {
        form.addEventListener('submit', function(e) {
            console.log('Form submit event fired - DIRECT TEST');
            console.log('Form data:', new FormData(form));
        });
        console.log('Form submit event listener added');
    }
});
</script>
{% endblock %}
