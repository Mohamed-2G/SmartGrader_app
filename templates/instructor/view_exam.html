{% extends "base.html" %}

{% block title %}{{ uploaded_exam.title }} - SmartGrader{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-file-alt me-2"></i>
        {{ uploaded_exam.title }}
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{{ url_for('instructor.exams') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i>
            Back to Exams
        </a>
        <a href="{{ url_for('instructor.download_exam', exam_id=uploaded_exam.id) }}" class="btn btn-outline-primary ms-2">
            <i class="fas fa-download me-2"></i>
            Download Exam
        </a>
        <button class="btn btn-outline-danger ms-2" onclick="deleteExam({{ uploaded_exam.id }})">
            <i class="fas fa-trash me-2"></i>
            Delete Exam
        </button>
    </div>
</div>

<div class="row">
    <!-- Exam Details -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    Exam Details
                </h5>
            </div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-4">Title:</dt>
                    <dd class="col-sm-8">{{ uploaded_exam.title }}</dd>
                    
                    {% if uploaded_exam.subject %}
                    <dt class="col-sm-4">Subject:</dt>
                    <dd class="col-sm-8">{{ uploaded_exam.subject }}</dd>
                    {% endif %}
                    
                    {% if uploaded_exam.description %}
                    <dt class="col-sm-4">Description:</dt>
                    <dd class="col-sm-8">{{ uploaded_exam.description }}</dd>
                    {% endif %}
                    
                    <dt class="col-sm-4">File Type:</dt>
                    <dd class="col-sm-8">{{ uploaded_exam.file_type|title }}</dd>
                    
                    <dt class="col-sm-4">Uploaded:</dt>
                    <dd class="col-sm-8">{{ uploaded_exam.uploaded_at.strftime('%Y-%m-%d %H:%M') }}</dd>
                    
                    <dt class="col-sm-4">Status:</dt>
                    <dd class="col-sm-8">
                        {% if uploaded_exam.is_processed %}
                            <span class="badge bg-success">Processed</span>
                        {% else %}
                            <span class="badge bg-warning">{{ uploaded_exam.processing_status|title }}</span>
                        {% endif %}
                    </dd>
                    
                    {% if uploaded_exam.is_processed %}
                    <dt class="col-sm-4">Questions:</dt>
                    <dd class="col-sm-8">{{ uploaded_exam.total_questions }}</dd>
                    
                    <dt class="col-sm-4">Total Points:</dt>
                    <dd class="col-sm-8">{{ uploaded_exam.total_points }}</dd>
                    {% endif %}
                </dl>
                
                {% if not uploaded_exam.is_processed %}
                <div class="mt-3">
                    {% if uploaded_exam.processing_status == 'failed' %}
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Processing failed. PDF text extraction may not work properly.
                        </div>
                    {% endif %}
                    <div class="d-flex gap-2">
                        <button class="btn btn-primary" onclick="processExam({{ uploaded_exam.id }})">
                            <i class="fas fa-cog me-2"></i>
                            Try Auto-Process
                        </button>
                        <a href="{{ url_for('instructor.add_questions_page', exam_id=uploaded_exam.id) }}" class="btn btn-success">
                            <i class="fas fa-plus me-2"></i>
                            Add Questions Manually
                        </a>
                    </div>
                </div>
                {% else %}
                <div class="mt-3">
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>
                        Exam processed successfully! {{ uploaded_exam.total_questions }} questions extracted.
                    </div>
                    {% if uploaded_exam.total_questions == 1 %}
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Only 1 question detected. PDF parsing may have missed questions. 
                            <a href="{{ url_for('instructor.add_questions_page', exam_id=uploaded_exam.id) }}" class="alert-link">Add questions manually</a> for better results.
                        </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Submissions -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-users me-2"></i>
                    Student Submissions ({{ submissions|length }})
                </h5>
            </div>
            <div class="card-body">
                                     {% if submissions %}
                         <div class="d-flex justify-content-between align-items-center mb-3">
                             <h6 class="mb-0">Student Submissions</h6>
                             <div class="btn-group" role="group">
                                 <button class="btn btn-sm btn-outline-warning" onclick="reevaluateAllSubmissions({{ uploaded_exam.id }})">
                                     <i class="fas fa-redo me-1"></i>
                                     Re-evaluate All
                                 </button>
                                 <button class="btn btn-sm btn-outline-danger" onclick="deleteAllSubmissions({{ uploaded_exam.id }}, {{ submissions|length }})">
                                     <i class="fas fa-trash me-1"></i>
                                     Delete All
                                 </button>
                             </div>
                         </div>
                         <div class="list-group list-group-flush">
                             {% for submission in submissions %}
                             <div class="list-group-item">
                                 <div class="d-flex justify-content-between align-items-start">
                                     <div class="flex-grow-1">
                                         <h6 class="mb-1">{{ submission.student_name }}</h6>
                                         <p class="mb-1 text-muted small">
                                             <i class="fas fa-id-card"></i> {{ submission.student_id }}
                                             <br><i class="fas fa-calendar"></i> {{ submission.submitted_at.strftime('%Y-%m-%d %H:%M') }}
                                         </p>
                                         <div class="mt-2">
                                             {% if submission.is_graded %}
                                                 <span class="badge bg-success">Graded</span>
                                                 <span class="badge bg-info">{{ submission.total_score }}/{{ submission.max_score }}</span>
                                             {% else %}
                                                 <span class="badge bg-warning">{{ submission.grading_status|title }}</span>
                                             {% endif %}
                                         </div>
                                     </div>
                                     <div class="ms-3">
                                         <a href="{{ url_for('instructor.view_submission', submission_id=submission.id) }}" 
                                            class="btn btn-sm btn-outline-primary">
                                             <i class="fas fa-eye"></i> View
                                         </a>
                                         <button class="btn btn-sm btn-outline-danger ms-1" onclick="deleteSubmission({{ submission.id }}, '{{ submission.student_name }}')">
                                             <i class="fas fa-trash"></i>
                                         </button>
                                     </div>
                                 </div>
                             </div>
                             {% endfor %}
                         </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No submissions yet.</p>
                        <p class="text-muted small">Students will appear here once they submit their answers.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
function processExam(examId) {
    // Show loading bar
    const { modal, interval } = showBulkLoadingBar('AI Exam Processing in Progress...');
    
    fetch(`/instructor/exam/${examId}/process`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        hideBulkLoadingBar(modal, interval);
        
        if (data.success) {
            // Show success message briefly before reload
            const successModal = document.createElement('div');
            successModal.className = 'modal fade show';
            successModal.style.display = 'block';
            successModal.style.backgroundColor = 'rgba(0,0,0,0.5)';
            successModal.innerHTML = `
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-body text-center py-4">
                            <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                            <h5 class="text-success">Exam Processing Completed!</h5>
                            <p class="text-muted">Questions extracted successfully</p>
                            <p class="text-muted small">Reloading results...</p>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(successModal);
            
            setTimeout(() => {
                successModal.remove();
                location.reload();
            }, 2000);
        } else {
            alert('Error processing exam: ' + data.error);
            location.reload();
        }
    })
    .catch(error => {
        hideBulkLoadingBar(modal, interval);
        console.error('Error:', error);
        alert('Error processing exam. Please try again.');
        location.reload();
    });
}

function deleteExam(examId) {
    if (confirm('Are you sure you want to delete this exam? This action cannot be undone and will remove all exam data.')) {
        fetch(`/instructor/exam/${examId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Exam deleted successfully!');
                window.location.href = '/instructor/exams';
            } else {
                alert('Error deleting exam: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting exam. Please try again.');
        });
    }
}

function deleteSubmission(submissionId, studentName) {
    if (confirm(`Are you sure you want to delete ${studentName}'s submission? This action cannot be undone.`)) {
        fetch(`/instructor/submission/${submissionId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Submission deleted successfully!');
                location.reload();
            } else {
                alert('Error deleting submission: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting submission. Please try again.');
        });
    }
}

function deleteAllSubmissions(examId, submissionCount) {
    if (confirm(`Are you sure you want to delete all ${submissionCount} submissions for this exam? This action cannot be undone.`)) {
        // Get all submission IDs for this exam
        const submissionItems = document.querySelectorAll('.list-group-item');
        const submissionIds = [];
        
        submissionItems.forEach(item => {
            const deleteBtn = item.querySelector('button[onclick*="deleteSubmission"]');
            if (deleteBtn) {
                const onclick = deleteBtn.getAttribute('onclick');
                const match = onclick.match(/deleteSubmission\((\d+)/);
                if (match) {
                    submissionIds.push(parseInt(match[1]));
                }
            }
        });
        
        if (submissionIds.length === 0) {
            alert('No submissions found to delete.');
            return;
        }
        
        // Delete all submissions
        let deletedCount = 0;
        const totalCount = submissionIds.length;
        
        submissionIds.forEach((submissionId, index) => {
            fetch(`/instructor/submission/${submissionId}/delete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                deletedCount++;
                if (data.success) {
                    console.log(`Deleted submission ${submissionId}`);
                } else {
                    console.error(`Error deleting submission ${submissionId}:`, data.error);
                }
                
                // If all deletions are complete, reload the page
                if (deletedCount === totalCount) {
                    alert(`Successfully deleted ${deletedCount} submissions!`);
                    location.reload();
                }
            })
            .catch(error => {
                deletedCount++;
                console.error(`Error deleting submission ${submissionId}:`, error);
                
                if (deletedCount === totalCount) {
                    alert(`Deleted ${deletedCount} submissions with some errors.`);
                    location.reload();
                }
            });
        });
    }
}

function showBulkLoadingBar(message = 'AI Bulk Re-evaluation in Progress...') {
    // Create a modal overlay for bulk operations
    const modal = document.createElement('div');
    modal.className = 'modal fade show';
    modal.style.display = 'block';
    modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
    modal.innerHTML = `
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center py-4">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <h5 class="text-primary">${message}</h5>
                    <div class="progress mt-3" style="height: 8px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" 
                             style="width: 0%" 
                             id="bulk-grading-progress">
                        </div>
                    </div>
                    <p class="text-muted mt-2 small">This may take several minutes for multiple submissions...</p>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    
    // Animate progress bar
    const progressBar = document.getElementById('bulk-grading-progress');
    let progress = 0;
    const interval = setInterval(() => {
        progress += Math.random() * 10;
        if (progress > 85) progress = 85;
        progressBar.style.width = progress + '%';
    }, 800);
    
    return { modal, interval };
}

function hideBulkLoadingBar(modal, interval) {
    if (interval) clearInterval(interval);
    if (modal) {
        modal.remove();
    }
}

function reevaluateAllSubmissions(examId) {
    // Show loading bar
    const { modal, interval } = showBulkLoadingBar('AI Bulk Re-evaluation in Progress...');
    
    fetch(`/instructor/exam/${examId}/reevaluate_all`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        hideBulkLoadingBar(modal, interval);
        
        if (data.success) {
            // Show success message briefly before reload
            const successModal = document.createElement('div');
            successModal.className = 'modal fade show';
            successModal.style.display = 'block';
            successModal.style.backgroundColor = 'rgba(0,0,0,0.5)';
            successModal.innerHTML = `
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-body text-center py-4">
                            <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                            <h5 class="text-success">Bulk Re-evaluation Completed!</h5>
                            <p class="text-muted">${data.reevaluated_count} submissions re-evaluated successfully</p>
                            ${data.failed_count > 0 ? `<p class="text-warning">${data.failed_count} submissions failed</p>` : ''}
                            <p class="text-muted small">Reloading results...</p>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(successModal);
            
            setTimeout(() => {
                successModal.remove();
                location.reload();
            }, 2000);
        } else {
            alert('Error re-evaluating submissions: ' + data.error);
            location.reload();
        }
    })
    .catch(error => {
        hideBulkLoadingBar(modal, interval);
        console.error('Error:', error);
        alert('Error re-evaluating submissions. Please try again.');
        location.reload();
    });
}
</script>
{% endblock %}
