{% extends "base.html" %}

{% block title %}Submission - {{ submission.student_name }} - SmartGrader{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-user-graduate me-2"></i>
        {{ submission.student_name }}'s Submission
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{{ url_for('instructor.view_exam', exam_id=uploaded_exam.id) }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i>
            Back to Exam
        </a>
        <a href="{{ url_for('instructor.download_submission', submission_id=submission.id) }}" class="btn btn-outline-primary ms-2">
            <i class="fas fa-download me-2"></i>
            Download Submission
        </a>
        <button class="btn btn-outline-danger ms-2" onclick="deleteSubmission({{ submission.id }}, '{{ submission.student_name }}')">
            <i class="fas fa-trash me-2"></i>
            Delete Submission
        </button>
    </div>
</div>

<div class="row">
    <!-- Submission Details -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    Submission Details
                </h5>
            </div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-5">Student:</dt>
                    <dd class="col-sm-7">{{ submission.student_name }}</dd>
                    
                    <dt class="col-sm-5">Student ID:</dt>
                    <dd class="col-sm-7">{{ submission.student_id }}</dd>
                    
                    <dt class="col-sm-5">Exam:</dt>
                    <dd class="col-sm-7">{{ uploaded_exam.title }}</dd>
                    
                    <dt class="col-sm-5">Submitted:</dt>
                    <dd class="col-sm-7">{{ submission.submitted_at.strftime('%Y-%m-%d %H:%M') }}</dd>
                    
                    <dt class="col-sm-5">File Type:</dt>
                    <dd class="col-sm-7">{{ submission.file_type|title }}</dd>
                    
                    <dt class="col-sm-5">Status:</dt>
                    <dd class="col-sm-7">
                        {% if submission.is_graded %}
                            <span class="badge bg-success">Graded</span>
                        {% else %}
                            <span class="badge bg-warning">{{ submission.grading_status|title }}</span>
                        {% endif %}
                    </dd>
                    
                    {% if submission.is_graded %}
                    <dt class="col-sm-5">Score:</dt>
                    <dd class="col-sm-7">
                        <strong>{{ submission.total_score }}/{{ submission.max_score }}</strong>
                        {% if submission.max_score > 0 %}
                            <br><small class="text-muted">{{ "%.1f"|format((submission.total_score / submission.max_score) * 100) }}%</small>
                        {% else %}
                            <br><small class="text-muted">N/A</small>
                        {% endif %}
                    </dd>
                    
                    <dt class="col-sm-5">Grading Status:</dt>
                    <dd class="col-sm-7">
                        <span class="badge bg-success">{{ submission.grading_status|title }}</span>
                    </dd>
                    {% endif %}
                </dl>
                
                {% if not submission.is_graded %}
                <div class="mt-3">
                    <button class="btn btn-primary" onclick="gradeSubmission({{ submission.id }})">
                        <i class="fas fa-check me-2"></i>
                        Grade Submission
                    </button>
                </div>
                {% else %}
                <div class="mt-3">
                    <button class="btn btn-warning" onclick="reevaluateSubmission({{ submission.id }})">
                        <i class="fas fa-redo me-2"></i>
                        Re-evaluate
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Question Answers -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-list me-2"></i>
                    Question Answers
                </h5>
            </div>
            <div class="card-body" id="submission-content">
                {% if question_answers %}
                    <!-- Answer Summary -->
                    {% set total_answers = question_answers|length %}
                    {% set extracted_answers = question_answers|selectattr('answer_text')|selectattr('answer_text', 'ne', 'No answer provided')|selectattr('answer_text', 'ne', 'No specific answer found for this question in the uploaded file')|list|length %}
                    {% set missing_answers = total_answers - extracted_answers %}
                    
                    <div class="alert alert-info mb-3">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Answer Summary:</strong> 
                        {{ extracted_answers }} out of {{ total_answers }} answers successfully extracted
                        {% if missing_answers > 0 %}
                            <span class="text-warning">({{ missing_answers }} answers could not be extracted)</span>
                        {% endif %}
                    </div>
                    
                    {% for qa in question_answers %}
                    <div class="card mb-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">Question {{ qa.question_number }}</h6>
                            {% if qa.score is not none %}
                            <span class="badge bg-info">{{ qa.score }}/{{ qa.max_score }}</span>
                            {% endif %}
                        </div>
                        <div class="card-body">
                            {% if qa.question_text %}
                            <div class="mb-3">
                                <strong>Question:</strong>
                                <p class="mb-0">{{ qa.question_text }}</p>
                            </div>
                            {% endif %}
                            
                            <div class="mb-3">
                                <strong>Student's Answer:</strong>
                                {% if qa.answer_text %}
                                    <div class="border rounded p-2 bg-light">
                                        <p class="mb-0">{{ qa.answer_text }}</p>
                                    </div>
                                    {% if "No specific answer found for this question in the uploaded file" in qa.answer_text %}
                                        <small class="text-warning">
                                            <i class="fas fa-exclamation-triangle me-1"></i>
                                            Answer could not be automatically extracted from uploaded file
                                        </small>
                                    {% elif "No answer provided" in qa.answer_text %}
                                        <small class="text-muted">
                                            <i class="fas fa-info-circle me-1"></i>
                                            No answer provided by student
                                        </small>
                                    {% else %}
                                        <small class="text-success">
                                            <i class="fas fa-check me-1"></i>
                                            Answer successfully extracted and saved
                                        </small>
                                    {% endif %}
                                {% elif qa.answer_image_path %}
                                    <p class="mb-0">
                                        <i class="fas fa-image me-2"></i>
                                        Answer provided as image
                                    </p>
                                {% else %}
                                    <p class="mb-0 text-muted">No answer provided</p>
                                {% endif %}
                            </div>
                            
                            {% if qa.feedback %}
                            <div class="mb-3">
                                <strong>Feedback:</strong>
                                <p class="mb-0">{{ qa.feedback }}</p>
                            </div>
                            {% endif %}
                            
                            {% if qa.confidence_score %}
                            <div>
                                <small class="text-muted">
                                    <i class="fas fa-chart-line me-1"></i>
                                    AI Confidence: {{ "%.1f"|format(qa.confidence_score * 100) }}%
                                </small>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-question-circle fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No question answers found.</p>
                        <p class="text-muted small">Answers will appear here once the submission is processed.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
function showLoadingBar(containerId, message = 'AI Grading in Progress...') {
    const container = document.getElementById(containerId);
    if (container) {
        container.innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h5 class="text-primary">${message}</h5>
                <div class="progress mt-3" style="height: 8px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" 
                         style="width: 0%" 
                         id="grading-progress">
                    </div>
                </div>
                <p class="text-muted mt-2 small">This may take a few moments...</p>
            </div>
        `;
        
        // Animate progress bar
        const progressBar = document.getElementById('grading-progress');
        let progress = 0;
        const interval = setInterval(() => {
            progress += Math.random() * 15;
            if (progress > 90) progress = 90;
            progressBar.style.width = progress + '%';
        }, 500);
        
        return interval;
    }
    return null;
}

function gradeSubmission(submissionId) {
    // Show loading bar
    const loadingInterval = showLoadingBar('submission-content', 'AI Grading in Progress...');
    
    fetch(`/instructor/submission/${submissionId}/grade`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (loadingInterval) clearInterval(loadingInterval);
        
        if (data.success) {
            // Show success message briefly before reload
            const container = document.getElementById('submission-content');
            if (container) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                        <h5 class="text-success">Grading Completed Successfully!</h5>
                        <p class="text-muted">Reloading results...</p>
                    </div>
                `;
                setTimeout(() => location.reload(), 1500);
            }
        } else {
            alert('Error grading submission: ' + data.error);
            location.reload();
        }
    })
    .catch(error => {
        if (loadingInterval) clearInterval(loadingInterval);
        console.error('Error:', error);
        alert('Error grading submission. Please try again.');
        location.reload();
    });
}

function deleteSubmission(submissionId, studentName) {
    // Show loading bar
    const loadingInterval = showLoadingBar('submission-content', 'Deleting Submission...');
    
    fetch(`/instructor/submission/${submissionId}/delete`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (loadingInterval) clearInterval(loadingInterval);
        
        if (data.success) {
            // Show success message briefly before redirect
            const container = document.getElementById('submission-content');
            if (container) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                        <h5 class="text-success">Submission Deleted Successfully!</h5>
                        <p class="text-muted">Redirecting to exam page...</p>
                    </div>
                `;
                setTimeout(() => {
                    window.location.href = '/instructor/exam/{{ uploaded_exam.id }}';
                }, 1500);
            }
        } else {
            alert('Error deleting submission: ' + data.error);
            location.reload();
        }
    })
    .catch(error => {
        if (loadingInterval) clearInterval(loadingInterval);
        console.error('Error:', error);
        alert('Error deleting submission. Please try again.');
        location.reload();
    });
}

function reevaluateSubmission(submissionId) {
    // Show loading bar
    const loadingInterval = showLoadingBar('submission-content', 'AI Re-evaluation in Progress...');
    
    fetch(`/instructor/submission/${submissionId}/reevaluate`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (loadingInterval) clearInterval(loadingInterval);
        
        if (data.success) {
            // Show success message briefly before reload
            const container = document.getElementById('submission-content');
            if (container) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                        <h5 class="text-success">Re-evaluation Completed Successfully!</h5>
                        <p class="text-muted">Reloading results...</p>
                    </div>
                `;
                setTimeout(() => location.reload(), 1500);
            }
        } else {
            alert('Error re-evaluating submission: ' + data.error);
            location.reload();
        }
    })
    .catch(error => {
        if (loadingInterval) clearInterval(loadingInterval);
        console.error('Error:', error);
        alert('Error re-evaluating submission. Please try again.');
        location.reload();
    });
}
</script>
{% endblock %}
